name: Deploy

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment (e.g. production, development)"
        required: true
        type: string
      app_name:
        description: "Application name (used for /srv/apps/<app_name>, defaults to repo name)"
        required: false
        type: string
        default: ""
      compose_file:
        description: "Docker Compose file to use (e.g. docker-compose.prod.yml)"
        required: true
        type: string
      env_vars:
        description: "Environment variables as KEY=VALUE pairs, separated by newlines"
        required: true
        type: string
    secrets:
      SSH_HOST:
        required: true
      SSH_USER:
        required: true
      SSH_KEY:
        required: true

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  call-ci-workflow:
    name: CI
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    needs: [call-ci-workflow]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare environment variables with automatic NODE_ENV
        id: prepare-env
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        run: |
          # Automatically set NODE_ENV based on environment
          NODE_ENV_VALUE="${{ inputs.environment == 'production' && 'production' || 'development' }}"

          # Remove any existing NODE_ENV from provided env_vars to avoid conflicts
          # Then append automatic NODE_ENV at the end to ensure it has priority
          CLEANED_ENV_VARS=$(echo "${{ inputs.env_vars }}" | grep -v "^NODE_ENV=" || true)

          # Add secrets from environment (available in job context)
          cat >> $GITHUB_OUTPUT << EOF
          env_vars<<ENVEOF
          POSTGRES_USER=${POSTGRES_USER:-postgres}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_DB=${POSTGRES_DB:-app_db}
          $CLEANED_ENV_VARS
          NODE_ENV=$NODE_ENV_VALUE
          ENVEOF
          EOF

      - name: Deploy using generic deploy action
        uses: ./.github/actions/deploy
        with:
          ssh_host: ${{ secrets.SSH_HOST }}
          ssh_user: ${{ secrets.SSH_USER }}
          ssh_key: ${{ secrets.SSH_KEY }}
          app_name: ${{ inputs.app_name }}
          compose_file: ${{ inputs.compose_file }}
          env_vars: ${{ steps.prepare-env.outputs.env_vars }}
